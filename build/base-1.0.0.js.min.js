/*! base-1.0.0.js 2016-04-28 */
function TetrisScreen(a){this.tetris=a,this.Width_T=Math.ceil((this.tetris.offsetWidth-25)/25),this.Heigth_T=Math.ceil((this.tetris.offsetHeight-25)/25),this.createPixel()}function Block(a,b){this.ScreenArea=a,this.DataPixel=b,this.shape}function Handler(a,b,c,d){this.init(a,b,c,d)}function waiting(){myHandler.startGame(500)}var StaticFn={replaceClass:function(a,b,c){for(var d=a.className||a.getAttribute("class"),e=d.split(" "),f=[],g=0,h=e.length;h>g;g++)e[g]!=b&&e[g]!=c&&f.push(e[g]);c?f.push(c):"";var i=f.join(" ");(a.className=i)||a.setAttribute&&a.setAttribute("class",i)}};TetrisScreen.prototype={constructor:TetrisScreen,arrScreen:new Array,createPixel:function(){for(var a='<div class="blocks fl borW" index="{0}" coordinate="{1}"></div>',b="",c=0;c<this.Heigth_T;c++){this.arrScreen[c]=new Array;for(var d=0;d<this.Width_T;d++)b+=this.formatString(a,(this.Width_T*c+d).toString(),d.toString()+","+c.toString()),this.arrScreen[c][d]={Width_T:d,Height_T:c}}this.tetris.innerHTML=b},getPrePixel:function(){return{Width_T:this.Width_T,Height_T:this.Heigth_T}},formatString:function(a,b){for(var c=!0,d=0,e=arguments.length;e>d;d++)if("string"!=typeof arguments[d]){c=!1;break}if(!c)return"Args list error!";for(var f,g=0,h=arguments.length-1;h>g;g++)f=new RegExp("{["+g.toString()+"]}","g"),a=a.replace(f,arguments[g+1]);return a}},Block.prototype={constructor:Block,createBlock:function(a){var b,c,d,e=void 0==a?~~(7*Math.random()):a,f=this.getShape(e);this.shape=e;for(var g=0,h=f.length;h>g;g++)b=f[g][0],c=f[g][1],d=this.ScreenArea.children[this.formatAddress(b,c)],StaticFn.replaceClass(d,"borW","borB")},getShape:function(a){var b=this.DataPixel.Width_T/2>2?this.DataPixel.Width_T/2-1:0,c=this.DataPixel.Width_T/2>2?0:1;switch(a){case 0:return[[b+0,c+0],[b+0,c+1],[b+1,c+1],[b+2,c+1]];case 1:return[[b+2,c+0],[b+0,c+1],[b+1,c+1],[b+2,c+1]];case 2:return[[b+1,c+0],[b+0,c+1],[b+1,c+1],[b+2,c+1]];case 3:return[[b+1,c+0],[b+2,c+0],[b+1,c+1],[b+2,c+1]];case 4:return[[b+0,c+0],[b+1,c+0],[b+2,c+0],[b+3,c+0]];case 5:return[[b+1,c+0],[b+2,c+0],[b+0,c+1],[b+1,c+1]];case 6:return[[b+0,c+0],[b+1,c+0],[b+1,c+1],[b+2,c+1]]}},formatAddress:function(a,b){return this.DataPixel.Width_T*b+a},getPreShape:function(){return this.shape},changeBlock:function(){var a=this.ScreenArea.getElementsByClassName("borB"),b=new Array,c={};b=[a[0].getAttribute("index"),a[1].getAttribute("index"),a[2].getAttribute("index"),a[3].getAttribute("index")];for(var d=0,e=b.length;e>d;d++)c=this.ScreenArea.children[parseInt(b[d])],StaticFn.replaceClass(c,"borB","borW");this.createBlock()}},Handler.prototype={constructor:Handler,init:function(a,b,c,d){this.arrOper=a.getElementsByTagName("div"),this.win=b,this.block=c,this.preBlock=d,this.startIntId=0,this.isStop=!1,this.tetris=document.getElementById("Tetris"),this.arrBlock=this.tetris.getElementsByClassName("borB"),this.finish=!1,this.gradeNum=document.getElementById("grade"),this.timeFlag,this.timeStaIntId=0,this.limitTimer_H=document.getElementById("limitTimer_H"),this.limitTimer_H_Show=document.getElementById("limitTimer_H_Show"),this.val_Time=0},keyDown:function(a){this.key(a,0)},keyPress:function(a){this.key(a,1)},keyUp:function(a){this.key(a,2)},key:function(a,b){var c;switch(a=a||window.event,c=a.keyCode||a.which||a.charCode){case 37:this.press("Left",b),this.leftMove(b);break;case 38:this.press("Up",b),this.upChange(b);break;case 39:this.press("Right",b),this.rightMove(b);break;case 40:this.press("Down",b),this.downMove(b);break;case 82:this.press("Reset",b),this.resetGame(b);break;case 83:this.press("Stop",b),this.doubleS("Stop",b)}},press:function(a,b){var c=this.arrOper[a];1>b?StaticFn.replaceClass(c,"bk","bkPress"):b>1&&StaticFn.replaceClass(c,"bkPress","bk")},checkMove:function(a,b){for(var c,d,e=new Array,f=!0,g=0,h=this.arrBlock.length;h>g;g++){if(e[g]=this.arrBlock[g].getAttribute("coordinate"),c=parseInt(e[g].split(",")[0]),d=parseInt(e[g].split(",")[1]),1==a&&9==c){f=!1;break}if(0==a&&0==c){f=!1;break}if(2==a&&21==d||3==a&&21==d){f=!1;break}if(c>0&&0==a&&-1!=this.tetris.children[c-1+10*d].className.search("bkB")){f=!1;break}if(9>c&&1==a&&-1!=this.tetris.children[c+1+10*d].className.search("bkB")){f=!1;break}if(21>d&&(2==a||3==a)&&-1!=this.tetris.children[c+10*(d+1)].className.search("bkB")){f=!1;break}}return f},leftMove:function(a){if(!(a>1)&&!this.isStop&&!this.finish&&this.checkMove(0))for(var b,c,d=new Array,e=new Array,f=0,g=this.arrBlock.length;g>f;f++)d[f]=this.arrBlock[f].getAttribute("index"),e[f]=this.arrBlock[f].getAttribute("coordinate"),b=parseInt(e[f].split(",")[0]),c=parseInt(e[f].split(",")[1]),StaticFn.replaceClass(this.tetris.children[parseInt(d[f])],"borB","borW"),StaticFn.replaceClass(this.tetris.children[10*c+b-1],"borW","borB")},upChange:function(a){if(!(a>=1||this.isStop||this.finish)){var b=this.block.getPreShape();if(3!=b){for(var c,d=new Array,e=new Array,f=!0,g=new Array,h=!0,i=0,j=this.arrBlock.length;j>i;i++)d[i]=this.arrBlock[i].getAttribute("index"),e[i]=[parseInt(this.arrBlock[i].getAttribute("coordinate").split(",")[0]),parseInt(this.arrBlock[i].getAttribute("coordinate").split(",")[1])];switch(b){case 0:if(e[0][0]==e[1][0]&&e[1][1]==e[2][1]){if(c=1,0==e[c][0]||1==e[c][1])return void(h=!1);g=[0,1,2,3]}else if(e[1][0]==e[3][0]&&e[2][1]==e[3][1]){if(c=3,1==e[c][0]||21==e[c][1])return void(h=!1);g=[2,3,0,1]}else if(e[1][1]==e[2][1]&&e[2][0]==e[3][0]){if(c=2,9==e[c][0]||20==e[c][1])return void(h=!1);g=[3,0,1,2]}else if(e[0][1]==e[1][1]&&e[0][0]==e[2][0]){if(c=0,8==e[c][0])return void(h=!1);g=[1,0,2,3]}break;case 1:if(e[0][0]==e[3][0]&&e[2][1]==e[3][1]){if(c=3,21==e[c][1])return void(h=!1);g=[1,2,3,0]}else if(e[0][1]==e[1][1]&&e[1][0]==e[2][0]){if(c=1,9==e[c][0]||8==e[c][0])return void(h=!1);g=[3,2,1,0]}else if(e[0][1]==e[2][1]&&e[0][0]==e[3][0])c=0,g=[2,1,0,3];else if(e[1][0]==e[2][0]&&e[2][1]==e[3][1]){if(c=2,1==e[c][0]||0==e[c][0])return void(h=!1);g=[0,1,2,3]}break;case 2:if(e[1][1]==e[2][1]&&e[2][1]==e[3][1]){if(c=2,21==e[c][1])return void(h=!1);g=[1,0,2,3]}else if(e[0][0]==e[2][0]&&e[2][0]==e[3][0]){if(c=2,9==e[c][0])return void(h=!1);g=[3,1,2,0]}else if(e[0][1]==e[1][1]&&e[1][1]==e[2][1])c=1,g=[2,3,0,1];else if(e[0][0]==e[1][0]&&e[1][0]==e[3][0]){if(c=1,0==e[c][0])return void(h=!1);g=[0,2,1,3]}break;case 4:if(e[0][0]==e[1][0]){if(c=2,f=!1,0==e[c][0]||9==e[c][0]||8==e[c][0])return void(h=!1);g=[0,1,2,3]}else{if(c=1,f=!0,0==e[c][1]||1==e[c][1])return void(h=!1);g=[0,1,2,3]}break;case 5:if(e[0][1]==e[1][1]){if(c=0,0==e[c][1])return void(h=!1);g=[1,0,2,3]}else{if(c=1,f=!1,0==e[c][0])return void(h=!1);g=[3,2,1,0]}break;case 6:if(e[0][1]==e[1][1]){if(c=1,0==e[c][1])return void(h=!1);g=[3,2,1,0]}else{if(c=1,f=!1,0==e[c][0])return void(h=!1);g=[3,1,2,0]}}for(var i=0,j=g.length;j>i;i++)if(g[i]!=c){var k=e[g[i]][0]-e[c][0],l=e[g[i]][1]-e[c][1];if(f){if(-1!=this.tetris.children[10*(-k+e[c][1])+l+e[c][0]].className.search("bkB")){h=!1;break}}else if(-1!=this.tetris.children[10*(k+e[c][1])-l+e[c][0]].className.search("bkB")){h=!1;break}}if(h)for(var i=0,j=g.length;j>i;i++)if(g[i]!=c){var k=e[g[i]][0]-e[c][0],l=e[g[i]][1]-e[c][1];StaticFn.replaceClass(this.tetris.children[parseInt(d[g[i]])],"borB","borW"),f?StaticFn.replaceClass(this.tetris.children[10*(-k+e[c][1])+l+e[c][0]],"borW","borB"):StaticFn.replaceClass(this.tetris.children[10*(k+e[c][1])-l+e[c][0]],"borW","borB")}}}},rightMove:function(a){if(!(a>1||this.isStop||this.finish)&&this.checkMove(1))for(var b,c,d=new Array,e=new Array,f=this.arrBlock.length-1;f>=0;f--)d[f]=this.arrBlock[f].getAttribute("index"),e[f]=this.arrBlock[f].getAttribute("coordinate"),b=parseInt(e[f].split(",")[0]),c=parseInt(e[f].split(",")[1]),StaticFn.replaceClass(this.tetris.children[parseInt(d[f])],"borB","borW"),StaticFn.replaceClass(this.tetris.children[10*c+b+1],"borW","borB")},downMove:function(a){a>1||this.isStop||this.finish||this.setBlock(this,2)},resetGame:function(a){a>=1||(this.win.location.href=this.win.location.href)},doubleS:function(a,b){var c=this.arrOper[a];this.finish||(0===b&&"stop"==c.innerHTML?(c.innerHTML="start",this.stopGame(),this.isStop=!0):0===b&&"start"==c.innerHTML&&(c.innerHTML="stop",this.startGame(this.timeFlag),this.isStop=!1))},setBlock:function(a,b){a=a||this,type=b||3;var c,d,e=new Array,f=new Array;if(e=[a.arrBlock[0].getAttribute("index"),a.arrBlock[1].getAttribute("index"),a.arrBlock[2].getAttribute("index"),a.arrBlock[3].getAttribute("index")],f=[a.arrBlock[0].getAttribute("coordinate"),a.arrBlock[1].getAttribute("coordinate"),a.arrBlock[2].getAttribute("coordinate"),a.arrBlock[3].getAttribute("coordinate")],!a.checkMove(type)){for(var g=0,h=e.length;h>g;g++)StaticFn.replaceClass(a.tetris.children[parseInt(e[g])],"borB","borB_P bkB");if(a.listenBlock(f),!a.checkAddBlock(a.preBlock.getPreShape()))return;return a.block.createBlock(a.preBlock.getPreShape()),void a.preBlock.changeBlock()}for(var i=a.arrBlock.length-1;i>=0;i--)c=parseInt(f[i].split(",")[0]),d=parseInt(f[i].split(",")[1]),StaticFn.replaceClass(a.tetris.children[parseInt(e[i])],"borB","borW"),StaticFn.replaceClass(a.tetris.children[10*(d+1)+c],"borW","borB")},checkAddBlock:function(a){var b=!0;switch(a){case 0:case 1:case 2:-1==this.tetris.children[14].className.search("bkB")&&-1==this.tetris.children[15].className.search("bkB")&&-1==this.tetris.children[16].className.search("bkB")||(b=!1);break;case 3:case 6:-1==this.tetris.children[15].className.search("bkB")&&-1==this.tetris.children[16].className.search("bkB")||(b=!1);break;case 4:-1!=this.tetris.children[4].className.search("bkB")&&(b=!1);break;case 5:-1==this.tetris.children[14].className.search("bkB")&&-1==this.tetris.children[15].className.search("bkB")||(b=!1)}return b||this.gameOver(),b},gameOver:function(){this.stopGame(),alert(" Game Over ! \n You Grade: "+this.gradeNum.innerHTML+" ! \n Use Time: "+this.limitTimer_H.value+"s !"),this.finish=!0},listenBlock:function(a){var b,c,d,e=new Array,f=new Array,g=0,h=0;b=Math.max(parseInt(a[0].split(",")[1]),parseInt(a[1].split(",")[1]),parseInt(a[2].split(",")[1]),parseInt(a[3].split(",")[1])),c=Math.min(parseInt(a[0].split(",")[1]),parseInt(a[1].split(",")[1]),parseInt(a[2].split(",")[1]),parseInt(a[3].split(",")[1]));for(var i=0;b-c+1>i;i++){g=0;for(var j=0;10>j;j++){if(-1==this.tetris.children[10*(b-i)+j].className.search("bkB")){e.push({isC:!1,row:b-i});break}g++}if(10==g){h++,this.gradeNum.innerHTML=parseInt(this.gradeNum.innerHTML)+1,e.push({isC:!0,row:b-i});for(var k=0;10>k;k++)StaticFn.replaceClass(this.tetris.children[10*(b-i)+k],"borB_P"),StaticFn.replaceClass(this.tetris.children[10*(b-i)+k],"bkB","borW")}}if(0!=h){d=this.limitTimer_H_Show.children,"09"==d[2].innerHTML&&parseInt(d[0].innerHTML)+10*h-60>=0?(d[2].innerHTML="10",d[0].innerHTML="00"):"09"!=d[2].innerHTML&&parseInt(d[0].innerHTML)+10*h-60>=0?(d[2].innerHTML="0"+(parseInt(d[2].innerHTML)+1),d[0].innerHTML=parseInt(d[0].innerHTML)+10*h-60>10?parseInt(d[0].innerHTML)+10*h-60:"0"+(parseInt(d[0].innerHTML)+10*h-60),parseInt(d[2].innerHTML)>=1&&StaticFn.replaceClass(this.limitTimer_H_Show,"ul_red","ul_green")):d[0].innerHTML=(parseInt(d[0].innerHTML)+10*h).toString();var l,m,n=0,o=0;f=this.tetris.getElementsByClassName("borB_P");for(var p=f.length-1;p>=0;p--)if(l=parseInt(f[p].getAttribute("coordinate").split(",")[0]),m=parseInt(f[p].getAttribute("coordinate").split(",")[1]),!(m>b)){if(b>=m&&m>=c){for(var q=e.length;q>o;o++)if(e[o].isC||m==e[o].row)if(e[o].isC)n++;else if(m==e[o].row)break}else n=h;StaticFn.replaceClass(this.tetris.children[10*m+l],"borB_P"),StaticFn.replaceClass(this.tetris.children[10*m+l],"bkB","borW"),StaticFn.replaceClass(this.tetris.children[10*(m+n)+l],"borW","borB_P bkB")}}},startGame:function(a){var b=this;this.timeFlag=a,this.timeStaIntId=this.win.setInterval(function(){b.limitTimer(b)},1e3),this.startIntId=this.win.setInterval(function(){b.setBlock(b)},a)},stopGame:function(){this.win.clearInterval(this.startIntId),this.win.clearInterval(this.timeStaIntId)},limitTimer:function(a){a=a||this;var b=a.limitTimer_H_Show.children;a.val_Time=-1*a.val_Time+1,b[1].innerHTML=a.val_Time?"：":"&nbsp;","00"==b[0].innerHTML&&"00"!=b[2].innerHTML?(b[2].innerHTML="0"+(parseInt(b[2].innerHTML)-1),b[0].innerHTML="59","00"==b[2].innerHTML&&StaticFn.replaceClass(a.limitTimer_H_Show,"ul_green","ul_red")):"00"==b[0].innerHTML&&"00"==b[2].innerHTML?a.gameOver():"00"!=b[0].innerHTML&&(b[0].innerHTML=parseInt(b[0].innerHTML)<=10?"0"+(parseInt(b[0].innerHTML)-1):parseInt(b[0].innerHTML)-1),a.limitTimer_H.value=parseInt(a.limitTimer_H.value)+1}};var preScreen=new TetrisScreen(document.getElementById("Next")),preBlock=new Block(document.getElementById("Next"),preScreen.getPrePixel()),myScreen=new TetrisScreen(document.getElementById("Tetris")),myBlock=new Block(document.getElementById("Tetris"),myScreen.getPrePixel()),myHandler=new Handler(document.getElementById("Operator"),window,myBlock,preBlock);window.onkeydown=function(a){myHandler.keyDown(a)},window.onkeyup=function(a){myHandler.keyUp(a)},window.onkeypress=function(a){myHandler.keyPress(a)},window.onclick=function(a){switch(a.target.innerHTML){case"stop":myHandler.key({keyCode:83},0);break;case"start":myHandler.key({keyCode:83},0);break;case"reset":myHandler.key({keyCode:82},0);break;case"up":myHandler.key({keyCode:38},0);break;case"left":myHandler.key({keyCode:37},0);break;case"down":myHandler.key({keyCode:40},0);break;case"right":myHandler.key({keyCode:39},0);break;default:console.log("no Element")}},window.onload=function(){preBlock.createBlock(),myBlock.createBlock(),waiting()};